name: Deploy to GCP

on:
  push:
    branches: [release]
  workflow_dispatch:

jobs:
  build-and-deploy:
    if: github.ref == 'refs/heads/release'
    runs-on: ubuntu-latest

    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
      GCP_SSH_KEY: ${{ secrets.GCP_SSH_KEY }}
      GCP_USER: ${{ secrets.GCP_USER }}
      GCP_HOST: ${{ secrets.GCP_HOST }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Log in to Docker Hub
      run: echo "${DOCKERHUB_PASSWORD}" | docker login -u "${DOCKERHUB_USERNAME}" --password-stdin

    - name: Build and Push frontend
      run: |
        docker build -t $DOCKERHUB_USERNAME/ai-codemate-fe:latest ./frontend
        docker push $DOCKERHUB_USERNAME/ai-codemate-fe:latest

    - name: Build and Push backend
      run: |
        docker build -t $DOCKERHUB_USERNAME/ai-codemate-be:latest ./backend
        docker push $DOCKERHUB_USERNAME/ai-codemate-be:latest

    - name: Build and Push socket-server
      run: |
        docker build -t $DOCKERHUB_USERNAME/ai-codemate-socket:latest ./socket-server
        docker push $DOCKERHUB_USERNAME/ai-codemate-socket:latest

    - name: Deploy to GCP
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ env.GCP_HOST }}
        username: ${{ env.GCP_USER }}
        key: ${{ env.GCP_SSH_KEY }}
        script: |
          docker pull $DOCKERHUB_USERNAME/frontend:latest
          docker pull $DOCKERHUB_USERNAME/backend:latest
          docker pull $DOCKERHUB_USERNAME/socket-server:latest
          cd /home/fd_dongle/codemate
          docker compose down
          docker compose up -d
