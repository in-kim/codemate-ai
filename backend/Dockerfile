FROM node:24-alpine

WORKDIR /app

COPY package*.json ./
RUN npm install -g pnpm
RUN pnpm install

COPY . .

# 빌드 시 환경변수 받기
ARG MONGO_URI
ARG GOOGLE_APPLICATION_CREDENTIALS
ARG VERTEX_PROJECT_ID
ARG VERTEX_LOCATION
ARG GITHUB_CLIENT_SECRET
ARG GITHUB_CLIENT_ID
ARG FRONTEND_URL
ARG JWT_SECRET
ARG JWT_INVITE_SECRET
ARG JWT_INVITE_EXPIRES_IN
ARG JWT_EXPIRES_IN
ARG JWT_REFRESH_EXPIRES_IN

# 환경변수 설정
ENV MONGO_URI=$MONGO_URI
ENV GOOGLE_APPLICATION_CREDENTIALS=$GOOGLE_APPLICATION_CREDENTIALS
ENV VERTEX_PROJECT_ID=$VERTEX_PROJECT_ID
ENV VERTEX_LOCATION=$VERTEX_LOCATION
ENV GITHUB_CLIENT_SECRET=$GITHUB_CLIENT_SECRET
ENV GITHUB_CLIENT_ID=$GITHUB_CLIENT_ID
ENV FRONTEND_URL=$FRONTEND_URL
ENV JWT_SECRET=$JWT_SECRET
ENV JWT_INVITE_SECRET=$JWT_INVITE_SECRET
ENV JWT_INVITE_EXPIRES_IN=$JWT_INVITE_EXPIRES_IN
ENV JWT_EXPIRES_IN=$JWT_EXPIRES_IN
ENV JWT_REFRESH_EXPIRES_IN=$JWT_REFRESH_EXPIRES_IN

# 4000번 포트 노출
EXPOSE 4000

CMD ["pnpm", "start:prod"]  